<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Barry — Админ панель</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <link rel="icon" href="/static/logo.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>
<body>
<div id="page-loader">
  <div class="spinner-wrapper">
    <div class="spinner-ring"></div>
    <img src="/static/logo-w.png" alt="Логотип" class="spinner-logo">
  </div>
  <p id="loader-status" class="loader-text"></p>

</div>

    <nav class="side-nav">
        <button id="toggle-nav" class="toggle-button">❮</button>
    <div class="logo-container">
        <img src="/static/logo.png" alt="Логотип" class="nav-image">
    </div>
        <h2 class="side-nav-title">Навигация</h2>
    <ul>
        <li><a href="#header">В начало</a></li>
        <hr>
        <li><a href="#users">Аккаунты</a></li>
        <hr>
        <li><a href="#tenants">Организации</a></li>
        <hr>
        <li><a href="#statistics">Статистика</a></li>
        <hr>
        <li><a href="#models">Модели</a></li>
        <hr>
        <li><a href="#create">Добавить аккаунт</a></li>
    </ul>
</nav>
    <header id="header">
        Админ панель | {{ admin_login }} | <a href="/logout">Выйти</a>
        <p class="info">Наведитесь на элемент, чтобы увидеть подсказку</p>
        
    </header>

    <main class="dashboard ">
        
        <section id="users" class="card full glass-card">
            <h2>Список аккаунтов</h2>
            <div class="table-wrapper">
            <input type="text" id="userSearch" placeholder="Поиск по логину..." class="search-input">
            <select id="roleFilter" class="search-input">
                <option value="">Все роли</option>
                <option value="user">User</option>
                <option value="admin">Admin</option>
            </select>

            <table class="user-table">
              
                <thead>
                    <tr><th>Эндпоинт</th><th>Логин</th><th>Роль</th><th>Действия</th></tr>
                </thead>
                <tbody id="userTable">
                    {% for u in users %}
                    <tr>
                        <td>{{ u.tenant_id }}</td>
                        <td>{{ u.email }}</td>
                        <td>{{ u.role }}</td>
                        <td class="buttons">
                            <a class="btn blue wait" href="/admin/edit_user/{{ u.email }}">Редактировать</a>
                            <a class="btn red delete no-loader" href="/admin/delete_user/{{ u.email }}" onclick="return confirm('Точно удалить?')">Удалить</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </section>
        <section id="tenants" class="card full glass-card">
            <h2>Организации</h2>
            <div class="table-wrapper">
<div class="filter-row">
  <input type="text" id="tenantSearch" placeholder="Поиск по эндпоинту..." class="search-input">

  <select id="modelFilter" class="search-input">
    <option value="">Все модели</option>
    {% for model in gpt_models %}
    <option value="{{ model }}">{{ model }}</option>
    {% endfor %}
  </select>

  <select id="filesFilter" class="search-input">
    <option value="">Файлы: все</option>
    <option value="✔">✔</option>
    <option value="✖">✖</option>
  </select>

  <select id="multiFilter" class="search-input">
    <option value="">Мультиканальность: все</option>
    <option value="✔">✔</option>
    <option value="✖">✖</option>
  </select>
</div>

                <table class="user-table">
                    <thead>
                    <tr><th>Эндпоинт</th><th class="api-key-cell">Pyrus ключ</th><th class="api-key-cell">Модель</th><th style="width: 80px;">Обработка файлов</th><th style="width: 80px;">Мультиканальность</th><th>Действия</th></tr>
                </thead>
                <tbody>
                {% for t in tenants %}
                <tr>
                    <td class="api-key-cell">{{ t.tenant_id }}</td>
                    <td class="api-key-cell">{{ t.pyrus_key }}</td>
                    <td class="api-key-cell">{{ t.gpt_model }}</td>
                    <td class="api-key-cell" style="text-align: center;">{% if t.allow_attachments_toggle %}✔{% else %}✖{% endif %}</td>
                    <td class="api-key-cell" style="text-align: center;">{% if t.allow_multi_channel_toggle %}✔{% else %}✖{% endif %}</td>
                    <td class="buttons">
                        <a class="btn blue wait" href="/admin/edit_tenant/{{ t.tenant_id }}">Редактировать</a>
                        <a class="btn red delete no-loader" href="/admin/delete_tenant/{{ t.tenant_id }}" onclick="return confirm('Удалить организацию?')">Удалить</a>
                    </td>
                </tr>
                {% endfor %}
                </tbody>

            </table>
            </div>
        </section>


<section id="statistics" class="card full glass-card">
    <h2>Статистика</h2>
    <div class="table-wrapper">
        <table class="user-table">
            <thead>
                <tr>
                    <th>Эндпоинт</th>
                    <th title="Дата подключения интеграции к CRM">Дата подключения</th>
                    <th title="Сумма, оплачиваемая за интеграцию ежемесячно">Сумма/месяц</th>
                    <th title="Количество поступивших запросов за текущий месяц">Запросы</th>
                    <th title="Количество утвержденных задач за текущий месяц">Задачи</th>
                    <th title="Среднее количество запросов, приходящихся на одну задачу">Запросы на задачу</th>
                    <th title="Доля запросов клиента от всех поступивших запросов">Процент запросов</th>
                </tr>
            </thead>
            <tbody>
                {% for t in stats %}
                <tr>
                    <td class="api-key-cell" style="text-align: center;">{{ t.tenant_id }}</td>
                    <td class="api-key-cell" style="text-align: center;">{{ t.date }}</td>
                    <td class="api-key-cell" style="text-align: center;">{{ t.amount }}</td>
                    <td class="api-key-cell" style="text-align: center;">{{ t.request }}</td>
                    <td class="api-key-cell" style="text-align: center;">{{ t.tasks }}</td>
                    <td class="api-key-cell" style="text-align: center;">{{ t.reqpertasks }}</td>
                    <td class="api-key-cell" style="text-align: center;">{{ t.percentage }}</td>
                  </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>



<section id="models" class="card full glass-card">
    <h2>Модели ChatGPT</h2>
    <div class="table-wrapper">
    <table class="user-table">
        <thead>
            <tr><th>Название модели</th><th>Действия</th></tr>
        </thead>
        <tbody>
            {% for model in gpt_models %}
            <tr>
                <td>{{ model }}</td>
                <td class="buttons">
                    <a class="btn red delete no-loader" href="/admin/delete_model/{{ model }}" onclick="return confirm('Удалить модель {{ model }}?')">Удалить</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <div class="form-flex">
        <!-- Добавление модели -->
        <form method="POST" action="/admin/model">
            <h3>Добавить модель</h3>
            <br>
            <label title="Добавление новой существующей модели ChatGPT, которая существует в организации с вашим API ключом OpenAI">
                Название модели:
                <input type="text" name="gpt_model_name" placeholder="Название модели">
            </label>
            <div class="buttons">
                <button type="submit" class="save saving-btn no-loader">Добавить</button>
            </div>
        </form>

        <!-- Настройки API -->
        <form action="/admin/api_keys" method="post">
            <h3>Параметры API</h3>
            <br>
            <label title="Ключ для доступа к API OpenAI. Находится по адресу https://platform.openai.com/">
                OpenAI API ключ:
                <input type="text" id="openaiKey" name="openai_api_key" placeholder="OpenAI API ключ" value="{{ api_keys.openai_api_key }}" maxlength="500">
            </label>
            <div class="buttons">
                <button type="submit" class="save saving-btn no-loader">Сохранить</button>
                <button type="button" class="btn blue no-loader" id="validateKeyBtn" style="font-weight:normal">Проверить ключ</button>

            </div>
        </form>
    </div>
</section>
<section id="create" class="card full glass-card">
    <h2>Добавить аккаунт</h2>
    <form method="POST" action="/admin/create_user" class="form">
        <!-- Одиночные поля -->
        <label title="Эндпоинт находится в конце URL в настройках бота в Pyrus">Эндпоинт
            <input type="text" name="tenant_id">
        </label>
        <label title="Ключ для доступа к Pyrus API находится в настройках бота в Pyrus">Pyrus API ключ
            <input type="text" name="pyrus_key">
        </label>

        <!-- Группа полей в строку -->
        <div class="row">
            <label>Логин
                <input type="text" name="email" required>
            </label>
            <label>Пароль
                <input type="password" name="password" required>
            </label>
            <label>Роль
                <select name="role">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </label>
        </div>

        <div class="buttons">
            <button type="submit" class="saving-btn no-loader">Создать аккаунт</button>
        </div>
    </form>
</section>


    </main>
    <footer>Просто подвал
        <p>v5.2.4</p>
    </footer>
<script>
    const nav = document.querySelector('.side-nav');
const btn = document.getElementById('toggle-nav');

if (localStorage.getItem('navCollapsed') === 'true') {
  nav.classList.add('collapsed');
}

btn.addEventListener('click', () => {
  nav.classList.toggle('collapsed');
  localStorage.setItem('navCollapsed', nav.classList.contains('collapsed'));
});
document.querySelectorAll('.saving-btn').forEach(btn => {
  const form = btn.closest('form');
  if (form) {
    form.addEventListener('submit', function() {
      btn.disabled = true;
      btn.innerHTML = 'Сохранение... <span class="spinner"></span>';
    });
  }
});
document.querySelectorAll('.wait').forEach(btn => {
  btn.addEventListener('click', function (e) {
    btn.innerHTML = 'Загрузка... <span class="spinner"></span>';
  });
});
document.querySelectorAll('.delete').forEach(btn => {
  btn.addEventListener('click', function (e) {
    btn.disabled = true;
    btn.innerHTML = 'Удаление... <span class="spinner"></span>';
  });
});


document.getElementById('userSearch').addEventListener('input', function () {
  const value = this.value.toLowerCase();
  const rows = document.querySelectorAll('#userTable tr');

  rows.forEach(row => {
    const login = row.children[1]?.textContent.toLowerCase() || '';
    row.style.display = login.includes(value) ? '' : 'none';
  });
});
document.getElementById('tenantSearch').addEventListener('input', function () {
  const value = this.value.toLowerCase();
  const rows = document.querySelectorAll('#tenants tbody tr');

  rows.forEach(row => {
    const endpoint = row.children[0]?.textContent.toLowerCase() || '';
    row.style.display = endpoint.includes(value) ? '' : 'none';
  });
});

document.getElementById('roleFilter').addEventListener('change', function () {
  const value = this.value.toLowerCase();
  const rows = document.querySelectorAll('#userTable tr');

  rows.forEach(row => {
    const role = row.children[2]?.textContent.toLowerCase() || '';
    row.style.display = !value || role === value ? '' : 'none';
  });
});
function applyTenantFilters() {
  const modelVal = document.getElementById('modelFilter').value;
  const filesVal = document.getElementById('filesFilter').value;
  const multiVal = document.getElementById('multiFilter').value;

  const rows = document.querySelectorAll('#tenants tbody tr');

  rows.forEach(row => {
    const model = row.children[2]?.textContent.trim();
    const files = row.children[3]?.textContent.trim();
    const multi = row.children[4]?.textContent.trim();

    const matchModel = !modelVal || model === modelVal;
    const matchFiles = !filesVal || files === filesVal;
    const matchMulti = !multiVal || multi === multiVal;

    row.style.display = matchModel && matchFiles && matchMulti ? '' : 'none';
  });
}

['modelFilter', 'filesFilter', 'multiFilter'].forEach(id => {
  document.getElementById(id).addEventListener('change', applyTenantFilters);
});

document.getElementById('validateKeyBtn').addEventListener('click', async function () {
    const btn = this;
    const key = document.getElementById('openaiKey').value.trim();

    btn.disabled = true;
    btn.innerHTML = 'Проверка... <span class="spinner"></span>';

    if (!key.startsWith('sk-')) {
        btn.innerHTML = 'Неверный формат ключа';
        setTimeout(resetBtn, 3000);
        return;
    }

    try {
        const resp = await fetch('https://api.openai.com/v1/models', {
            headers: { 'Authorization': `Bearer ${key}` }
        });

        if (resp.ok) {
            btn.innerHTML = 'Ключ валиден';
        } else {
            btn.innerHTML = `Ошибка ${resp.status}`;
        }
    } catch (err) {
        btn.innerHTML = 'Ошибка запроса';
    }

    setTimeout(resetBtn, 3000);

    function resetBtn() {
        btn.disabled = false;
        btn.innerHTML = 'Проверить ключ';
    }
});
let lastClickedElement = null;

// сохраняем последний кликнутый элемент
document.addEventListener('mousedown', (e) => {
  lastClickedElement = e.target;
});

const loader = document.getElementById('page-loader');
const statusText = document.getElementById('loader-status');
const minTime = 2000;
const start = Date.now();

const loadingPhrases = [
  'Подключаем базу данных...',
  'Рисуем кнопки...',
  'Готовим интерфейс...',
  'Настраиваем стили...',
  'Закругляем углы...',
  'Выравниваем текст...'
];

const finalizingPhrases = [
  'Пинаем сервера...',
  'Сдуваем пыль...',
  'Вроде работает...',
  'Почти готово...',
  'Секунду...'
];

const requestPhrases = [
  'Загрузка...',
  'Запрашиваем ресурсы...',
  'Загружаем данные...',
  'Подгружаем карточки...',
  'Скачиваем файлы...',
  'Запрашиваем API...'
];
if (statusText) {
  const i = Math.floor(Math.random() * requestPhrases.length);
  statusText.textContent = requestPhrases[i];
}
window.addEventListener('load', () => {
  const elapsed = Date.now() - start;
  const delay = Math.max(0, minTime - elapsed);

  if (statusText) statusText.textContent = loadingPhrases[Math.floor(Math.random() * loadingPhrases.length)];

  setTimeout(() => {
    if (statusText) statusText.textContent = finalizingPhrases[Math.floor(Math.random() * finalizingPhrases.length)];
  }, delay - 1000);

  setTimeout(() => {
    if (loader) loader.style.display = 'none';
  }, delay);
});

window.addEventListener('beforeunload', () => {
  if (lastClickedElement?.classList.contains('no-loader')) return;

  if (loader) loader.style.display = 'flex';
  if (statusText) {
    const i = Math.floor(Math.random() * requestPhrases.length);
    statusText.textContent = requestPhrases[i];
  }
});
</script>
</body>
</html>
